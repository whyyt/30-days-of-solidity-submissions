//SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SimpleFitnessTracker {
    
    //å£°æ˜å˜é‡

    address public owner;
    //åˆ›å»ºç»“æ„å‚¨å­˜ç”¨æˆ·ä¿¡æ¯ï¼šåå­—ã€ä½“é‡ã€æ˜¯å¦æ³¨å†Œ
    struct UserProfile {
        string name;
        uint256 weight; 
        bool isRegistered;
    }
    //åˆ›å»ºç»“æ„å‚¨å­˜è¿åŠ¨ä¿¡æ¯ï¼šè¿åŠ¨ç±»å‹ã€æ—¶é•¿ã€è·ç¦»ã€æ—¶é—´
    struct WorkoutActivity {
        string activityType; 
        uint256 duration;    // in seconds
        uint256 distance;    // in meters
        uint256 timestamp;   
    }
    //ä½¿ç”¨mappingç»“æ„å°†ç›¸å…³å˜é‡è”ç³»åˆ°ä¸€èµ·
    mapping(address => UserProfile) public userAddressLinkProfile; //æ¯ä¸ªç”¨æˆ·åœ°å€å¯¹åº”ä¸€ä¸ªç”¨æˆ·ä¿¡æ¯ç»“æ„
    mapping(address => WorkoutActivity[]) private userAddressLinkworkoutHistory;  //æ¯ä¸ªç”¨æˆ·å¯¹åº”å¤šæ¬¡ç”¨æˆ·è¿åŠ¨ä¿¡æ¯(è¿åŠ¨ä¿¡æ¯æœ‰å¤šæ¬¡ï¼Œæ‰€ä»¥ç”¨æ•°ç»„ï¼‰
    mapping(address => uint256) public totalWorkouts; //ç”¨æˆ·åœ°å€å¯¹åº”ç”¨æˆ·æ€»è¿åŠ¨æ¬¡æ•°
    mapping(address => uint256) public totalDistance; //ç”¨æˆ·åœ°å€å¯¹åº”ç”¨æˆ·è¿åŠ¨æ€»è·ç¦»
    //è¿ç”¨eventè®°å½•ç”¨æˆ·äº‹ä»¶çš„å‘ç”Ÿå¹¶åšå‡ºç›¸åº”å“åº”ï¼Œæ ‡ä¸Šindexedçš„å‚æ•°å¯è¢«æ‰“ä¸Šæ ‡ç­¾æ–¹ä¾¿æŸ¥æ‰¾
    event UserRegistered(address indexed userAddress, string name, uint256 timestamp); //è®°å½•ç”¨æˆ·æˆåŠŸæ³¨å†Œ
    event ProfileUpdated(address indexed userAddress, uint256 newWeight, uint256 timestamp); //è®°å½•ç”¨æˆ·ä½“é‡ä¿¡æ¯çš„æ›´æ–°
    event WorkoutLogged( //è®°å½•ç”¨æˆ·ä¸€æ¬¡è¿åŠ¨çš„å®Œæˆ
        address indexed userAddress, 
        string activityType, 
        uint256 duration, 
        uint256 distance, 
        uint256 timestamp
    );
    event MilestoneAchieved(address indexed userAddress, string milestone, uint256 timestamp);//è®°å½•ç”¨æˆ·é‡Œç¨‹ç¢‘çš„è¾¾åˆ°
    
    //åˆå§‹åŒ–
    constructor() {
        owner = msg.sender;
    }
    

    //è®¾ç½®æƒé™
    modifier onlyRegistered() {
        require(userAddressLinkProfile[msg.sender].isRegistered, "User not registered");
        _;
    }
    
    // æ³¨å†Œæ–°ç”¨æˆ·
    function registerUser(string memory _name, uint256 _weight) public {
        require(!userAddressLinkProfile[msg.sender].isRegistered, "User already registered");
        //å¾€ç”¨æˆ·ä¿¡æ¯ç»“æ„å­˜å…¥ä¿¡æ¯ï¼ˆï¼ŸğŸˆè¯­æ³•ç»“æ„ï¼‰
        userAddressLinkProfile[msg.sender] = UserProfile({
            name: _name,
            weight: _weight,
            isRegistered: true
        });
        // è§¦å‘æ³¨å†Œäº‹ä»¶å“åº”
        emit UserRegistered(msg.sender, _name, block.timestamp);
    }
    
    //æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼šä½“é‡
    function updateWeight(uint256 _newWeight) public onlyRegistered {
        UserProfile storage profile = userAddressLinkProfile[msg.sender];
        
        // åˆ¤æ–­å‡é‡æ˜¯å¦è¾¾åˆ°æ„ä¹‰æ€§æ ‡å‡†ï¼šæ˜¯å¦å‡æ‰5%çš„ä½“é‡æˆ–è€…æ›´å¤šï¼Ÿ
        if (_newWeight < profile.weight && (profile.weight - _newWeight) * 100 / profile.weight >= 5) { //solidityä¸­æ²¡æœ‰å°æ•°é™¤æ³•ï¼Œå…ˆä¹˜100ç¡®ä¿ç™¾åˆ†æ¯”ç²¾åº¦
            emit MilestoneAchieved(msg.sender, "Weight Goal Reached", block.timestamp); //è§¦å‘é‡Œç¨‹ç¢‘äº‹ä»¶å“åº”
        }
        profile.weight = _newWeight; //æ›´æ–°ä½“é‡
        emit ProfileUpdated(msg.sender, _newWeight, block.timestamp); //è§¦å‘ç”¨æˆ·ä¿¡æ¯æ›´æ–°å“åº”
    }
    
    //è®°å½•æ¯ä¸€æ¬¡ç”¨æˆ·è¿åŠ¨çš„ä¿¡æ¯
    function logWorkout(
        string memory _activityType,
        uint256 _duration,
        uint256 _distance
    ) public onlyRegistered {
        //å¾€ç”¨æˆ·è¿åŠ¨ä¿¡æ¯ç»“æ„æ·»åŠ å†…å®¹ï¼ˆåŒä¸Šç”¨æˆ·ä¿¡æ¯ç»“æ„çš„å†…å®¹æ·»åŠ 
        WorkoutActivity memory newWorkout = WorkoutActivity({
            activityType: _activityType,
            duration: _duration,
            distance: _distance,
            timestamp: block.timestamp
        });       
        //å°†ä¸€æ¬¡è¿åŠ¨ä¿¡æ¯æ¨é€è¿›å†å²è¿åŠ¨åˆ—è¡¨
        userAddressLinkworkoutHistory[msg.sender].push(newWorkout);
       //è¿åŠ¨æ¬¡æ•°å’Œè¿åŠ¨è·ç¦»å¢åŠ 
        totalWorkouts[msg.sender]++;
        totalDistance[msg.sender] += _distance;        
        //è§¦å‘ä¸€æ¬¡è¿åŠ¨å®Œæˆçš„å“åº”
        emit WorkoutLogged(
            msg.sender,
            _activityType,
            _duration,
            _distance,
            block.timestamp
        );
        //åˆ¤æ–­æ˜¯å¦è¾¾åˆ°è¿åŠ¨æ¬¡æ•°é‡Œç¨‹ç¢‘
        if (totalWorkouts[msg.sender] == 10) {
            emit MilestoneAchieved(msg.sender, "10 Workouts Completed", block.timestamp);  //è§¦å‘10æ¬¡è¿åŠ¨æ¬¡æ•°é‡Œç¨‹ç¢‘äº‹ä»¶å“åº”
        } else if (totalWorkouts[msg.sender] == 50) {
            emit MilestoneAchieved(msg.sender, "50 Workouts Completed", block.timestamp);  //è§¦å‘50æ¬¡è¿åŠ¨æ¬¡æ•°é‡Œç¨‹ç¢‘äº‹ä»¶å“åº”
        }        
        //åˆ¤æ–­æ˜¯å¦è¾¾åˆ°è¿åŠ¨è·ç¦»é‡Œç¨‹ç¢‘ 
        if (totalDistance[msg.sender] >= 100000 && totalDistance[msg.sender] - _distance < 100000) { //ç¬¬äºŒä¸ªåˆ¤æ–­é€»è¾‘æ˜¯ä¸ºäº†ç¡®ä¿é¦–æ¬¡çªç ´10Kï¼ˆæ€»è·ç¦»å‡æ–°å¢è·ç¦»è¦å°äº10kï¼‰
            emit MilestoneAchieved(msg.sender, "100K Total Distance", block.timestamp); //è§¦å‘è¿åŠ¨è·ç¦»é‡Œç¨‹ç¢‘äº‹ä»¶å“åº”
        }
    }
    
    //æŸ¥çœ‹è¿åŠ¨æ¬¡æ•°ï¼ˆï¼Ÿèƒ½å¦é€šè¿‡totalWorkoutsè¿”å›ğŸˆ
    function getUserWorkoutCount() public view onlyRegistered returns (uint256) {
        return userAddressLinkworkoutHistory[msg.sender].length;
    }
}
